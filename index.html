<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulário de Cadastro</title>
    <style>
        body {
            font-family: sans-serif;
        }
        .container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            padding: 20px;
        }
        .column {
            width: 45%;
            margin: 10px;
        }
        .column:nth-child(2) {
            width: 50%;
        }
        .card {
            border: 1px solid #ccc;
            padding: 20px;
            margin-bottom: 10px;
        }
        h2 {
            margin-top: 0;
        }
        input, select, textarea {
            width: calc(100% - 12px);
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }
        textarea {
            height: 150px;
        }
        .btn-cadastrar {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <form id="dataForm">
        <div class="container">
            <div class="column">
                <div class="card">
                    <h2>Cadastro Básico</h2>
                    <input type="date" id="data" name="DATA" required>
                    <select id="prefeitura" name="PREFEITURA" required></select>
                    <select id="analista" name="ANALISTA" required></select>
                    <select id="folha" name="FOLHA" required></select>
                </div>
                <div class="card">
                    <h2>Situação da Verba</h2>
                    <select id="verba" name="VERBA" required></select>
                    <select id="status" name="STATUS" required></select>
                    <select id="situacao" name="SITUACAO" required></select>
                    <select id="apontamento" name="APONTAMENTO" required></select>
                </div>
            </div>
            <div class="column">
                <div class="card">
                    <h2>Análise Jurídica e Descrição da Norma aplicada</h2>
                    <select id="legislacao" name="LEGISLACAO" required></select>
                    <textarea id="descricao" name="DESCRICAO" placeholder="Descrição da Norma aplicada" required></textarea>
                    <textarea id="analise" name="ANALISE" placeholder="Análise, Fundamentação e Orientação do Analista" required></textarea>
                    <button type="submit" class="btn-cadastrar">Cadastrar Análise</button>
                </div>
            </div>
        </div>
    </form>

    <script>
        async function carregarLista(idCampo, coluna) {
            try {
                const response = await fetch(`https://sheetdb.io/api/v1/pmf5bt5s7m6tq?sheet=VALIDACAO`);
                const data = await response.json();
                const valoresUnicos = [...new Set(data.map(item => item[coluna]))].sort();
                const selectCampo = document.getElementById(idCampo);
                selectCampo.innerHTML = `<option value="">Selecione um ${idCampo}</option>`;
                valoresUnicos.forEach(valor => {
                    const option = document.createElement('option');
                    option.value = valor;
                    option.textContent = valor;
                    selectCampo.appendChild(option);
                });
            } catch (error) {
                console.error(`Erro ao carregar ${idCampo}:`, error);
            }
        }

        async function carregarPrefeituras() {
            try {
                const response = await fetch(`https://sheetdb.io/api/v1/pmf5bt5s7m6tq?sheet=MUNICIPIO`);
                const data = await response.json();
                const prefeituras = [...new Set(data.map(item => item.PREFEITURA))].sort();
                const selectPrefeitura = document.getElementById('prefeitura');
                selectPrefeitura.innerHTML = '<option value="">Selecione uma prefeitura</option>';
                prefeituras.forEach(prefeitura => {
                    const option = document.createElement('option');
                    option.value = prefeitura;
                    option.textContent = prefeitura;
                    selectPrefeitura.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar prefeituras:', error);
            }
        }

        async function carregarFiltrado(idCampo, aba, coluna, prefeitura) {
            try {
                const response = await fetch(`https://sheetdb.io/api/v1/pmf5bt5s7m6tq?sheet=${aba}`);
                const data = await response.json();
                const filtrados = [...new Set(data.filter(item => item.PREFEITURA === prefeitura).map(item => item[coluna]))].sort();
                const selectCampo = document.getElementById(idCampo);
                selectCampo.innerHTML = `<option value="">Selecione um ${idCampo}</option>`;
                filtrados.forEach(valor => {
                    const option = document.createElement('option');
                    option.value = valor;
                    option.textContent = valor;
                    selectCampo.appendChild(option);
                });
            } catch (error) {
                console.error(`Erro ao carregar ${idCampo}:`, error);
            }
        }

        document.getElementById('prefeitura').addEventListener('change', function () {
            const prefeitura = this.value;
            carregarFiltrado('verba', 'RESUMO', 'VERBA', prefeitura);
            carregarFiltrado('folha', 'RESUMO', 'FOLHA', prefeitura);
            carregarFiltrado('legislacao', 'LEGISLACAO', 'LEI', prefeitura);
        });

        document.getElementById('dataForm').addEventListener('submit', async function (event) {
            event.preventDefault();
            const formData = new FormData(this);
            const dataObj = {};
            formData.forEach((value, key) => dataObj[key] = value);
            try {
                const response = await fetch('https://sheetdb.io/api/v1/pmf5bt5s7m6tq?sheet=CADASTRO', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: [dataObj] })
                });
                if (response.ok) {
                    alert('Cadastro realizado com sucesso!');
                    this.reset();
                } else {
                    const errorData = await response.json();
                    console.error('Erro:', response.status, errorData);
                    alert(`Erro ao enviar os dados: ${response.status} - ${JSON.stringify(errorData)}`); // Alerta mais informativo
                }
            } catch (error) {
                console.error('Erro no envio:', error);
                alert('Ocorreu um erro de rede. Tente novamente mais tarde.');
            }
        });

        carregarPrefeituras();
        carregarLista('analista', 'ANALISTA');
        carregarLista('status', 'STATUS');
        carregarLista('apontamento', 'APONTAMENTO');
        carregarLista('situacao', 'SITUACAO');
    </script>
</body>
</html>
